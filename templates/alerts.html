{% extends "base.html" %}

{% block title %}{{ _('Alerts & Notifications') }} - 渔智汇{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>{{ _('Alerts & Notifications') }}</h2>
    <div>
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-1"></i>{{ _('Back to Home') }}
        </a>
    </div>
</div>

<!-- 预警统计 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">{{ _('Alerts Statistics') }}</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="data-card">
                            <div class="data-value text-danger" id="activeAlerts">--</div>
                            <div class="data-label">{{ _('Active Alerts') }}</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="data-card">
                            <div class="data-value text-warning" id="warningAlerts">--</div>
                            <div class="data-label">{{ _('Warning Level') }}</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="data-card">
                            <div class="data-value text-info" id="infoAlerts">--</div>
                            <div class="data-label">{{ _('Info Level') }}</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="data-card">
                            <div class="data-value text-success" id="resolvedToday">--</div>
                            <div class="data-label">{{ _('Resolved Today') }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 筛选和操作 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label for="alertFilter" class="form-label">{{ _('Alert Level') }}</label>
                        <select class="form-select" id="alertFilter" onchange="filterAlerts()">
                            <option value="all">{{ _('All Levels') }}</option>
                            <option value="danger">{{ _('Danger') }}</option>
                            <option value="warning">{{ _('Warning') }}</option>
                            <option value="info">{{ _('Info') }}</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label">{{ _('Status') }}</label>
                        <select class="form-select" id="statusFilter" onchange="filterAlerts()">
                            <option value="all">{{ _('All Status') }}</option>
                            <option value="active">{{ _('Active') }}</option>
                            <option value="resolved">{{ _('Resolved') }}</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="pondFilter" class="form-label">{{ _('Pond') }}</label>
                        <select class="form-select" id="pondFilter" onchange="filterAlerts()">
                            <option value="all">{{ _('All Ponds') }}</option>
                            {% for pond in ponds %}
                            <option value="{{ pond.id }}">{{ pond.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button class="btn btn-primary" onclick="refreshAlerts()">
                                <i class="fas fa-sync-alt me-1"></i>{{ _('Refresh') }}
                            </button>
                            <button class="btn btn-outline-secondary" onclick="markAllResolved()">
                                <i class="fas fa-check-double me-1"></i>{{ _('Mark All as Resolved') }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 活跃预警 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">{{ _('Active Alerts') }}</h5>
            </div>
            <div class="card-body">
                <div id="activeAlertsContainer">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>{{ _('Loading...') }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 预警历史 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">{{ _('Alert History') }}</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="alertsTable">
                        <thead>
                            <tr>
                                <th>{{ _('Time') }}</th>
                                <th>{{ _('Pond') }}</th>
                                <th>{{ _('Type') }}</th>
                                <th>{{ _('Level') }}</th>
                                <th>{{ _('Title') }}</th>
                                <th>{{ _('Status') }}</th>
                                <th>{{ _('Actions') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" class="text-center">{{ _('Loading...') }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 预警设置 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">{{ _('Alert Settings') }}</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>{{ _('Alert Threshold Settings') }}</h6>
                        <div class="mb-3">
                            <label for="doThreshold" class="form-label">{{ _('Dissolved Oxygen Threshold (mg/L)') }}</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="doThreshold" value="3.5" step="0.1" min="0" max="10">
                                <button class="btn btn-outline-secondary" onclick="updateThreshold('dissolved_oxygen')">
                                    <i class="fas fa-save"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="tempThreshold" class="form-label">{{ _('Temperature Threshold (°C)') }}</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="tempThreshold" value="32" step="0.5" min="0" max="50">
                                <button class="btn btn-outline-secondary" onclick="updateThreshold('temperature')">
                                    <i class="fas fa-save"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="phThreshold" class="form-label">{{ _('pH Threshold Range') }}</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="phMinThreshold" value="6.5" step="0.1" min="0" max="14" placeholder="{{ _('Minimum') }}">
                                <input type="number" class="form-control" id="phMaxThreshold" value="8.5" step="0.1" min="0" max="14" placeholder="{{ _('Maximum') }}">
                                <button class="btn btn-outline-secondary" onclick="updateThreshold('ph')">
                                    <i class="fas fa-save"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="ammoniaThreshold" class="form-label">{{ _('Ammonia Threshold (mg/L)') }}</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="ammoniaThreshold" value="0.6" step="0.1" min="0" max="2">
                                <button class="btn btn-outline-secondary" onclick="updateThreshold('ammonia')">
                                    <i class="fas fa-save"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>{{ _('Notification Settings') }}</h6>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="enableSmsAlerts" checked>
                            <label class="form-check-label" for="enableSmsAlerts">
                                {{ _('Enable SMS Alerts') }}
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="enableEmailAlerts" checked>
                            <label class="form-check-label" for="enableEmailAlerts">
                                {{ _('Enable Email Alerts') }}
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="enablePushAlerts" checked>
                            <label class="form-check-label" for="enablePushAlerts">
                                {{ _('Enable Push Alerts') }}
                            </label>
                        </div>
                        <div class="mb-3">
                            <label for="alertFrequency" class="form-label">{{ _('Alert Frequency') }}</label>
                            <select class="form-select" id="alertFrequency">
                                <option value="immediate">立即</option>
                                <option value="5min">5分钟</option>
                                <option value="15min">15分钟</option>
                                <option value="30min">30分钟</option>
                                <option value="1hour">1小时</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="saveNotificationSettings()">
                            <i class="fas fa-save me-1"></i>{{ _('Save Notification Settings') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 预警详情模态框 -->
<div class="modal fade" id="alertDetailModal" tabindex="-1" aria-labelledby="alertDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alertDetailModalLabel">预警详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="alertDetailContent">
                    <!-- 预警详情内容将在这里动态加载 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="resolveAlertBtn">标记已解决</button>
            </div>
        </div>
    </div>
</div>

<!-- 提示消息容器 -->
<div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 5"></div>
{% endblock %}

{% block scripts %}
<script>
var currentAlertId = null;

$(document).ready(function() {
    // 先刷新预警数据，确保数据一致性
    $.get('/alert/api/refresh_alerts', function() {
        // 加载活跃预警
        loadActiveAlerts();
        
        // 加载预警历史
        loadAlertHistory();
        
        // 加载预警统计
        loadAlertStatistics();
    });
    
    // 设置自动刷新
    setInterval(function() {
        $.get('/alert/api/refresh_alerts', function() {
            loadActiveAlerts();
            loadAlertStatistics();
        });
    }, 60000); // 每分钟刷新一次活跃预警和统计数据
});

// 加载活跃预警
function loadActiveAlerts() {
    $.get('/alert/api/active_alerts', function(data) {
        var container = $('#activeAlertsContainer');
        
        // 确保data是数组
        if (!Array.isArray(data)) {
            console.error('Expected array but got:', typeof data, data);
            container.html('<div class="text-center text-muted">数据加载错误</div>');
            return;
        }
        
        // 显示所有预警，但根据状态设置不同的样式
        if (data.length === 0) {
            container.html('<div class="text-center text-muted">暂无预警</div>');
            return;
        }
        
        var html = '';
        data.forEach(function(alert) {
            var levelClass = alert.level === 'danger' ? 'danger' : alert.level === 'warning' ? 'warning' : 'info';
            var iconClass = alert.type === 'dissolved_oxygen' ? 'fa-tint' : 
                           alert.type === 'temperature' ? 'fa-thermometer-half' : 
                           alert.type === 'ph' ? 'fa-flask' : 'fa-exclamation-triangle';
            
            // 如果预警已解决，使用不同的样式
            var alertClass = alert.status === 'resolved' ? 'alert-secondary' : `alert-${levelClass}`;
            var titleClass = alert.status === 'resolved' ? 'text-decoration-line-through' : '';
            var disabledAttr = alert.status === 'resolved' ? 'disabled' : '';
            
            html += `
                <div class="alert ${alertClass} alert-dismissible fade show mb-3" role="alert">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas ${iconClass} me-2"></i>
                                <h6 class="mb-0 ${titleClass}">${alert.title}</h6>
                                <span class="badge bg-${levelClass} ms-2">${alert.pond_name}</span>
                                ${alert.status === 'resolved' ? '<span class="badge bg-success ms-2">已解决</span>' : ''}
                            </div>
                            <p class="mb-2">${alert.message}</p>
                            <div class="small text-muted">
                                <i class="fas fa-clock me-1"></i>${alert.timestamp}
                            </div>
                        </div>
                        <div class="ms-3">
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewAlertDetail('${alert.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="markResolved('${alert.id}')" ${disabledAttr}>
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.html(html);
    });
}

// 加载预警历史
function loadAlertHistory() {
    var levelFilter = $('#alertFilter').val();
    var statusFilter = $('#statusFilter').val();
    var pondFilter = $('#pondFilter').val();
    
    $.get('/alert/api/alert_history', {
        level: levelFilter,
        status: statusFilter,
        pond: pondFilter
    }, function(data) {
        var tbody = $('#alertsTable tbody');
        tbody.empty();
        
        // 确保data是数组
        if (!Array.isArray(data)) {
            console.error('Expected array but got:', typeof data, data);
            tbody.append('<tr><td colspan="7" class="text-center text-danger">数据加载错误</td></tr>');
            return;
        }
        
        if (data.length === 0) {
            tbody.append('<tr><td colspan="7" class="text-center">暂无预警记录</td></tr>');
            return;
        }
        
        data.forEach(function(alert) {
            var levelBadge = alert.level === 'danger' ? 
                '<span class="badge bg-danger">危险</span>' : 
                alert.level === 'warning' ? 
                '<span class="badge bg-warning">警告</span>' : 
                '<span class="badge bg-info">信息</span>';
            
            var statusBadge = alert.status === 'active' ? 
                '<span class="badge bg-danger">活跃</span>' : 
                '<span class="badge bg-success">已解决</span>';
            
            var typeText = alert.type === 'dissolved_oxygen' ? '溶解氧' : 
                          alert.type === 'temperature' ? '温度' : 
                          alert.type === 'ph' ? 'pH值' : 
                          alert.type === 'ammonia' ? '氨氮' : '其他';
            
            tbody.append(`
                <tr>
                    <td>${alert.timestamp}</td>
                    <td>${alert.pond_name}</td>
                    <td>${typeText}</td>
                    <td>${levelBadge}</td>
                    <td>${alert.title}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewAlertDetail('${alert.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${alert.status === 'active' ? 
                            `<button class="btn btn-sm btn-outline-success" onclick="markResolved('${alert.id}')">
                                <i class="fas fa-check"></i>
                            </button>` : ''
                        }
                    </td>
                </tr>
            `);
        });
    });
}

// 加载预警统计
function loadAlertStatistics() {
    $.get('/alert/api/statistics', function(data) {
        $('#activeAlerts').text(data.active);
        $('#warningAlerts').text(data.warning);
        $('#infoAlerts').text(data.info);
        $('#resolvedToday').text(data.resolved_today);
    });
}

// 查看预警详情
function viewAlertDetail(alertId) {
    console.log('viewAlertDetail called with alertId:', alertId, 'type:', typeof alertId);
    currentAlertId = alertId;
    
    console.log('Making API call to /alert/api/alert_detail/' + alertId);
    $.get('/alert/api/alert_detail/' + alertId, function(data) {
        console.log('API response received:', data);
        var content = $('#alertDetailContent');
        
        var levelClass = data.level === 'danger' ? 'danger' : data.level === 'warning' ? 'warning' : 'info';
        var typeText = data.type === 'dissolved_oxygen' ? '溶解氧' : 
                      data.type === 'temperature' ? '温度' : 
                      data.type === 'ph' ? 'pH值' : 
                      data.type === 'ammonia' ? '氨氮' : '其他';
        
        content.html(`
            <div class="row">
                <div class="col-md-6">
                    <h6>基本信息</h6>
                    <table class="table table-sm">
                        <tr>
                            <td>预警类型:</td>
                            <td>${typeText}</td>
                        </tr>
                        <tr>
                            <td>预警级别:</td>
                            <td><span class="badge bg-${levelClass}">${data.level}</span></td>
                        </tr>
                        <tr>
                            <td>塘口:</td>
                            <td>${data.pond_name}</td>
                        </tr>
                        <tr>
                            <td>发生时间:</td>
                            <td>${data.timestamp}</td>
                        </tr>
                        <tr>
                            <td>状态:</td>
                            <td>${data.status === 'active' ? '活跃' : '已解决'}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>预警内容</h6>
                    <p>${data.message}</p>
                    
                    <h6>处理建议</h6>
                    <p>${data.suggestion || '暂无处理建议'}</p>
                </div>
            </div>
            
            ${data.chart_data ? `
            <div class="row mt-3">
                <div class="col-12">
                    <h6>相关数据趋势</h6>
                    <div class="chart-container">
                        <canvas id="alertChart"></canvas>
                    </div>
                </div>
            </div>
            ` : ''}
        `);
        
        // 如果有图表数据，创建图表
        if (data.chart_data) {
            createAlertChart(data.chart_data);
        }
        
        // 设置解决按钮状态
        $('#resolveAlertBtn').prop('disabled', data.status !== 'active');
        
        // 显示模态框
        var modal = new bootstrap.Modal(document.getElementById('alertDetailModal'));
        modal.show();
    }).fail(function(xhr, status, error) {
        console.error('Error loading alert detail:', status, error);
        console.error('Response text:', xhr.responseText);
        showToast('加载预警详情失败: ' + error, 'error');
    });
}

// 标记预警为已解决
function markResolved(alertId) {
    if (!confirm('确定要将此预警标记为已解决吗？')) {
        return;
    }
    
    $.post('/alert/api/mark_resolved/' + alertId, function(data) {
        if (data.success) {
            showToast('预警已标记为已解决', 'success');
            
            // 刷新活跃预警
            loadActiveAlerts();
            
            // 刷新预警历史
            loadAlertHistory();
            
            // 刷新预警统计
            loadAlertStatistics();
            
            // 如果模态框打开，关闭它
            var modal = bootstrap.Modal.getInstance(document.getElementById('alertDetailModal'));
            if (modal) {
                modal.hide();
            }
        } else {
            showToast('操作失败：' + data.message, 'error');
        }
    });
}

// 更新预警阈值
function updateThreshold(type) {
    var value;
    
    switch(type) {
        case 'dissolved_oxygen':
            value = $('#doThreshold').val();
            break;
        case 'temperature':
            value = $('#tempThreshold').val();
            break;
        case 'ph':
            var min = $('#phMinThreshold').val();
            var max = $('#phMaxThreshold').val();
            value = min + ',' + max;
            break;
        case 'ammonia':
            value = $('#ammoniaThreshold').val();
            break;
        default:
            return;
    }
    
    $.post('/alert/api/update_threshold', {
        type: type,
        value: value
    }, function(data) {
        if (data.success) {
            showToast('阈值更新成功', 'success');
        } else {
            showToast('阈值更新失败：' + data.message, 'error');
        }
    });
}

// 保存通知设置
function saveNotificationSettings() {
    var settings = {
        enableSms: $('#enableSmsAlerts').is(':checked'),
        enableEmail: $('#enableEmailAlerts').is(':checked'),
        enablePush: $('#enablePushAlerts').is(':checked'),
        frequency: $('#alertFrequency').val()
    };
    
    $.ajax({
        url: '/alert/api/update_notification_settings',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(settings),
        success: function(data) {
            if (data.success) {
                showToast('通知设置已保存', 'success');
            } else {
                showToast('保存失败：' + data.message, 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('保存通知设置失败:', error);
            showToast('保存通知设置失败，请稍后重试', 'error');
        }
    });
}

// 筛选预警
function filterAlerts() {
    loadAlertHistory();
}

// 刷新预警
function refreshAlerts() {
    // 先调用刷新API清除缓存
    $.get('/alert/api/refresh_alerts', function() {
        // 然后重新加载数据
        loadActiveAlerts();
        loadAlertHistory();
        loadAlertStatistics();
        showToast('预警数据已刷新', 'info');
    });
}

// 标记所有预警为已解决
function markAllResolved() {
    if (!confirm('确定要将所有活跃预警标记为已解决吗？')) {
        return;
    }
    
    // 调用API标记所有预警为已解决
    $.post('/alert/api/mark_all_resolved', function(data) {
        if (data.success) {
            showToast('所有活跃预警已标记为已解决', 'success');
            
            // 刷新数据
            loadActiveAlerts();
            loadAlertHistory();
            loadAlertStatistics();
        } else {
            showToast('操作失败: ' + data.message, 'error');
        }
    }).fail(function() {
        showToast('操作失败，请重试', 'error');
    });
}

// 创建预警详情图表
function createAlertChart(chartData) {
    // 如果已存在图表，先销毁
    if (window.alertChart) {
        window.alertChart.destroy();
    }
    
    var ctx = document.getElementById('alertChart').getContext('2d');
    
    window.alertChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: chartData.datasetLabel,
                data: chartData.data,
                borderColor: chartData.borderColor || '#007bff',
                backgroundColor: chartData.backgroundColor || 'rgba(0, 123, 255, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: false
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                annotation: {
                    annotations: {
                        line1: {
                            type: 'line',
                            yMin: chartData.threshold,
                            yMax: chartData.threshold,
                            borderColor: 'rgb(255, 99, 132)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                content: '阈值: ' + chartData.threshold,
                                enabled: true
                            }
                        }
                    }
                }
            }
        }
    });
}

// 显示提示消息
function showToast(message, type) {
    var toastContainer = $('#toast-container');
    var toastId = 'toast-' + Date.now();
    var bgClass = type === 'success' ? 'bg-success' : 
                  type === 'error' ? 'bg-danger' : 
                  type === 'warning' ? 'bg-warning' : 'bg-info';
    
    var toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.append(toastHtml);
    
    var toastElement = document.getElementById(toastId);
    var toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // 自动移除
    setTimeout(function() {
        $('#' + toastId).remove();
    }, 5000);
}
</script>
{% endblock %}